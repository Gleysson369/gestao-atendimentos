<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Relat√≥rio de Atendimentos</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/forms.css}">
    <link rel="stylesheet" th:href="@{/css/relatorio.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
</head>
<body>
    <div class="main-container">
        <header class="app-header">
            <h1>Relat√≥rio de Atendimentos</h1>
            <div class="user-info" sec:authorize="isAuthenticated()">
                </div>
        </header>

        <nav class="main-menu">
            <a th:href="@{/main}" class="menu-button">Tela Principal</a>
            <a href="/cadastro-usuario" class="menu-button" sec:authorize="hasRole('ADMIN')">Cadastro de Usu√°rio</a>
            <a href="/cadastro-atendimento" class="menu-button">Cadastro de Atendimentos</a>
        </nav>

        <main class="dashboard-content relatorio-content">
            <section class="card filter-card" id="filterCard">
                <h3>Filtros do Relat√≥rio</h3>
                <form id="filterForm" th:action="@{/relatorio-atendimentos}" method="get">
                    <div class="filter-grid">
                        <div class="input-group">
                            <label for="nomeCliente">Nome do Cliente:</label>
                            <input type="text" id="nomeCliente" name="nomeCliente" th:value="${filtros.nomeCliente}" placeholder="Digite o nome do cliente" />
                        </div>
                        <div class="input-group">
                            <label for="empresaCliente">Empresa do Cliente:</label>
                            <input type="text" id="empresaCliente" name="empresaCliente" th:value="${filtros.empresaCliente}" placeholder="Digite a empresa do cliente" />
                        </div>
                        <div class="input-group">
                            <label for="dataInicio">Data de In√≠cio:</label>
                            <input type="date" id="dataInicio" name="dataInicio" th:value="${filtros.dataInicio != null ? #temporals.format(filtros.dataInicio, 'yyyy-MM-dd') : ''}" />
                        </div>
                        <div class="input-group">
                            <label for="dataFim">Data Final:</label>
                            <input type="date" id="dataFim" name="dataFim" th:value="${filtros.dataFim != null ? #temporals.format(filtros.dataFim, 'yyyy-MM-dd') : ''}" />
                        </div>
                        <div class="input-group">
                            <label for="canalAtendimento">Canal de Atendimento:</label>
                            <select id="canalAtendimento" name="canalAtendimento">
                                <option value="">Todos</option>
                                <th:block th:each="canal : ${canaisAtendimento}">
                                    <option th:value="${canal.name()}"
                                                th:text="${canal.displayValue}"
                                                th:selected="${filtros.canalAtendimento == canal.name()}">
                                    </option>
                                </th:block>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="atendenteId">Atendente:</label>
                            <select id="atendenteId" name="atendenteId">
                                <option value="">Todos</option>
                                <option th:each="usuario : ${todosUsuarios}"
                                                th:value="${usuario.id}"
                                                th:text="${usuario.fullName}"
                                                th:selected="${filtros.atendenteId == usuario.id}"></option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="departamentoAtendente">Departamento Atendente:</label>
                            <select id="departamentoAtendente" name="departamentoAtendente">
                                <option value="">Todos</option>
                                <option th:each="depto : ${todosDepartamentos}" th:value="${depto.name()}" th:text="${depto.displayValue}" th:selected="${filtros.departamentoAtendente != null and filtros.departamentoAtendente == depto.name()}"></option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="atendimentoTransferencia">Atendimento de Transfer√™ncia:</label>
                            <select id="atendimentoTransferencia" name="atendimentoTransferencia">
                                <option value="">Todos</option>
                                <option value="true" th:selected="${T(java.lang.Boolean).TRUE.equals(filtros.atendimentoTransferencia)}">SIM</option>
                                <option value="false" th:selected="${T(java.lang.Boolean).FALSE.equals(filtros.atendimentoTransferencia)}">N√ÉO</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="protocoloAtendimento">Protocolo de Atendimento:</label>
                            <input type="text" id="protocoloAtendimento" name="protocoloAtendimento" th:value="${filtros.protocoloAtendimento}" placeholder="Digite o protocolo" />
                        </div>
                        <div class="input-group">
                            <label for="sortBy">Ordenar por:</label>
                            <select id="sortBy" name="sortBy">
                                <option value="dataHoraAtendimento" th:selected="${filtros.sortBy == 'dataHoraAtendimento'}">Data e Hora</option>
                                <option value="nomeCliente" th:selected="${filtros.sortBy == 'nomeCliente'}">Nome do Cliente</option>
                                <option value="usuarioAtendente.fullName" th:selected="${filtros.sortBy == 'usuarioAtendente.fullName'}">Atendente</option>
                                <option value="usuarioAtendente.departamento" th:selected="${filtros.sortBy == 'usuarioAtendente.departamento'}">Departamento</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="sortDir">Dire√ß√£o:</label>
                            <select id="sortDir" name="sortDir">
                                <option value="desc" th:selected="${filtros.sortDir == 'desc'}">Descendente</option>
                                <option value="asc" th:selected="${filtros.sortDir == 'asc'}">Ascendente</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group-form">
                        <button type="submit" name="aplicarFiltros" value="true" class="action-button primary-button">Aplicar Filtros</button>
                    </div>
                </form>
            </section>
        </main>

        <footer class="app-footer">
            <div class="user-profile">
                <img th:src="@{/img/Logo.png}" alt="Logo da Gest√£o de Atendimentos" class="app-logo-footer">
                <span class="user-name" sec:authorize="isAuthenticated()" sec:authentication="principal.fullName">Usu√°rio</span>
            </div>
            <form th:action="@{/logout}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="logout-button">Sair</button>
            </form>
        </footer>
    </div>

    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" onclick="closeReportModal()">X</button>
            <h4>Resultados do Relat√≥rio</h4>
            <div th:if="${errorMessage}" class="error-message">
                <p th:text="${errorMessage}"></p>
            </div>
            <div th:if="${!#lists.isEmpty(atendimentos)}" class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Atendente</th>
                            <th>Atendente</th>
                            <th>Departamento Atendente</th>
                            <th>ID Atendimento</th>
                            <th>Empresa do Cliente</th>
                            <th>Nome do Cliente</th>
                            <th>Data e Hora</th>
                            <th>Motivo do Contato</th>
                            <th>Solu√ß√£o Passada</th>
                            <th>Protocolo de Atendimento</th>
                            <th>N√∫mero da CRS</th>
                            <th>Telefone</th>
                            <th>AnyDesk</th>
                            <th>Canal de Atendimento</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="atendimento : ${atendimentos}">
                            <td th:text="${atendimento.usuarioAtendente?.id}" data-label="ID Atendente:">Usu√°rio ID</td>
                            <td th:text="${atendimento.usuarioAtendente?.fullName}" data-label="Atendente:">Nome Atendente</td>
                            <td th:text="${atendimento.usuarioAtendente?.departamento?.displayValue}" data-label="Departamento Atendente:">Depto Atendente</td>
                            <td th:text="${atendimento.id}" data-label="ID Atendimento:">1</td>
                            <td th:text="${atendimento.empresaCliente}" data-label="Empresa do Cliente:">Empresa Teste Ltda.</td>
                            <td th:text="${atendimento.nomeCliente}" data-label="Nome do Cliente:">Maria Silva</td>
                            <td th:text="${#temporals.format(atendimento.dataHoraAtendimento, 'dd/MM/yyyy HH:mm')}" data-label="Data e Hora:">01/01/2023 10:00</td>
                            <td th:text="${atendimento.motivoContato}" data-label="Motivo do Contato:">D√∫vida sobre o produto X.</td>
                            <td th:text="${atendimento.solucaoPassada}" data-label="Solu√ß√£o Passada:">Instru√ß√µes de uso detalhadas.</td>
                            <td th:text="${atendimento.protocoloAtendimento}" data-label="Protocolo de Atendimento:">1</td>
                            <td th:text="${atendimento.numeroCRS}" data-label="N√∫mero da CRS:">CRS-2023-001</td>
                            <td th:text="${atendimento.telefone}" data-label="Telefone:">(11) 98765-4321</td>
                            <td th:text="${atendimento.anydesk}" data-label="AnyDesk:">123 456 789</td>
                            <td th:text="${atendimento.canalAtendimento.displayValue}" data-label="Canal de Atendimento:">TELEFONE</td>
                            <td>
                                <button class="copy-button"
                                                th:data-motivo="${atendimento.motivoContato}"
                                                th:data-solucao="${atendimento.solucaoPassada}"
                                                th:data-datahora="${#temporals.format(atendimento.dataHoraAtendimento, 'dd/MM/yyyy HH:mm')}"
                                                th:data-nomecliente="${atendimento.nomeCliente}"
                                                th:data-empresacliente="${atendimento.empresaCliente}"
                                                th:data-canal="${atendimento.canalAtendimento.displayValue}"
                                                th:data-telefone="${atendimento.telefone}"
                                                th:data-anydesk="${atendimento.anydesk}"
                                                th:data-tipoocorrencia="${atendimento.tipoDeOcorrencia != null ? atendimento.tipoDeOcorrencia.displayValue : ''}"
                                                th:data-protocolo="${atendimento.protocoloAtendimento}"
                                                onclick="exibirDadosAtendimento(this)">Ver Texto</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${not #lists.isEmpty(atendimentos) or errorMessage != null}">
            </div>
            <div class="report-actions">
                <button type="button" class="action-button secondary-button" onclick="exportToExcel()">Exportar para Excel</button>
            </div>
        </div>
    </div>

    <div id="dataDisplayModal" class="data-modal-overlay">
        <div class="data-modal-content">
            <button class="close-button" onclick="closeDataDisplayModal()">X</button>
            <h4>Detalhes do Atendimento</h4>
            <div id="atendimentoDetailsDisplay"></div>
            <div class="button-group">
                <button type="button" class="action-button primary-button" onclick="copyTextFromDisplay()">Copiar Texto</button>
                <button type="button" class="action-button secondary-button" onclick="closeDataDisplayModal()">Fechar</button>
            </div>
        </div>
    </div>


    <script th:inline="javascript">
        const reportModal = document.getElementById('reportModal');
        const filterForm = document.getElementById('filterForm');
        // NOVO: Refer√™ncia ao novo modal e textarea
        const dataDisplayModal = document.getElementById('dataDisplayModal');
        const atendimentoDetailsTextarea = document.getElementById('atendimentoDetailsTextarea');


        function closeReportModal() {
            reportModal.style.display = 'none';
        }

        // NOVO: Fun√ß√£o para fechar o modal de exibi√ß√£o de dados
        function closeDataDisplayModal() {
            dataDisplayModal.style.display = 'none';
            atendimentoDetailsTextarea.value = ''; // Limpa o conte√∫do ao fechar
        }


        // Verifica se h√° resultados de atendimentos ou mensagem de erro para exibir o modal ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const atendimentos = [[${atendimentos}]]; // Acessa a vari√°vel 'atendimentos' do Thymeleaf
            const errorMessage = [[${errorMessage}]]; // Acessa a vari√°vel 'errorMessage' do Thymeleaf

            // Se houver atendimentos ou uma mensagem de erro, exibe o modal
            if ((atendimentos && atendimentos.length > 0) || errorMessage) {
                reportModal.style.display = 'flex';
            }
        });

        // Guarda os estilos originais dos elementos antes de escond√™-los
        const originalStyles = {};

        function hideElementsForPrint() {
            const elementsToHide = [
                document.querySelector('.app-header'),
                document.querySelector('.main-menu'),
                document.getElementById('filterCard'),
                document.querySelector('.app-footer'),
                document.querySelector('.modal-content .close-button'), // Esconder o bot√£o fechar
                document.querySelector('.modal-content .report-actions') // Esconder os bot√µes de a√ß√£o dentro do modal
            ];

            elementsToHide.forEach((el, index) => {
                if (el) {
                    originalStyles[index] = el.style.display;
                    el.style.display = 'none';
                }
            });
            // Adiciona um estilo para remover o fundo escuro do modal durante a impress√£o
            if (reportModal) {
                originalStyles['modalOverlayBg'] = reportModal.style.backgroundColor;
                originalStyles['modalPosition'] = reportModal.style.position;
                originalStyles['modalWidth'] = reportModal.style.width;
                originalStyles['modalHeight'] = reportModal.style.height;
                originalStyles['modalOverflow'] = reportModal.style.overflow;

                reportModal.style.backgroundColor = 'transparent';
                reportModal.style.position = 'static'; // Evita problemas de posicionamento na impress√£o
                reportModal.style.width = 'auto';
                reportModal.style.height = 'auto';
                reportModal.style.overflow = 'visible';

                // Tamb√©m ajuste o modal-content para impress√£o
                const modalContent = document.querySelector('.modal-content');
                if (modalContent) {
                    originalStyles['modalContentWidth'] = modalContent.style.width;
                    originalStyles['modalContentMaxWidth'] = modalContent.style.maxWidth;
                    originalStyles['modalContentHeight'] = modalContent.style.height;
                    originalStyles['modalContentMaxHeight'] = modalContent.style.maxHeight;
                    originalStyles['modalContentPadding'] = modalContent.style.padding;
                    originalStyles['modalContentBoxShadow'] = modalContent.style.boxShadow;
                    originalStyles['modalContentBorderRadius'] = modalContent.style.borderRadius;


                    modalContent.style.width = 'auto';
                    modalContent.style.maxWidth = 'none';
                    modalContent.style.height = 'auto';
                    modalContent.style.maxHeight = 'none';
                    modalContent.style.padding = '0'; // Remover padding para impress√£o
                    modalContent.style.boxShadow = 'none'; // Remover sombra
                    modalContent.style.borderRadius = '0'; // Remover borda
                }
            }
        }

        function showElementsAfterPrint() {
            const elementsToHide = [
                document.querySelector('.app-header'),
                document.querySelector('.main-menu'),
                document.getElementById('filterCard'),
                document.querySelector('.app-footer'),
                document.querySelector('.modal-content .close-button'),
                document.querySelector('.modal-content .report-actions')
            ];

            elementsToHide.forEach((el, index) => {
                if (el) {
                    el.style.display = originalStyles[index];
                }
            });
            if (reportModal && originalStyles['modalOverlayBg']) {
                reportModal.style.backgroundColor = originalStyles['modalOverlayBg'];
                reportModal.style.position = originalStyles['modalPosition'];
                reportModal.style.width = originalStyles['modalWidth'];
                reportModal.style.height = originalStyles['modalHeight'];
                reportModal.style.overflow = originalStyles['modalOverflow'];

                const modalContent = document.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.width = originalStyles['modalContentWidth'];
                    modalContent.style.maxWidth = originalStyles['modalContentMaxWidth'];
                    modalContent.style.height = originalStyles['modalContentHeight'];
                    modalContent.style.maxHeight = originalStyles['modalContentMaxHeight'];
                    modalContent.style.padding = originalStyles['modalContentPadding'];
                    modalContent.style.boxShadow = originalStyles['modalContentBoxShadow'];
                    modalContent.style.borderRadius = originalStyles['modalContentBorderRadius'];
                }
            }
        }

        // Fun√ß√£o para imprimir apenas a se√ß√£o de resultados (agora dentro do modal)
        function printResultsSection() {
            hideElementsForPrint();
            window.print();
            setTimeout(showElementsAfterPrint, 500);
        }

        // Fun√ß√£o para exportar para PDF (agora usando a mesma l√≥gica de impress√£o para PDF)
        function exportToPdf() {
            alert('A fun√ß√£o "Gerar PDF" √© um placeholder. Para PDF real, voc√™ precisaria de uma biblioteca ou integra√ß√£o com o backend.');
            printResultsSection(); // Reutiliza a fun√ß√£o de impress√£o de se√ß√£o
        }

        // Fun√ß√£o para exportar para Excel (CSV)
        function exportToExcel() {
            let csv = [];
            const rows = document.querySelectorAll("#reportModal .data-table tr"); // Seleciona linhas da tabela dentro do modal

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll("td, th");

                for (let j = 0; j < cols.length; j++) {
                    let data = cols[j].textContent.replace(/(\r\n|\n|\r)/gm, "").replace(/(\s\s)/gm, ' ').trim();
                    data = data.replace(/"/g, '\"\"'); // Escape aspas duplas
                    row.push('"' + data + '"');
                }
                if (row.length > 0) { // Garante que linhas vazias n√£o sejam adicionadas
                    csv.push(row.join(","));
                }
            }

            const csv_string = csv.join("\n");
            const filename = 'relatorio_atendimentos_' + new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') + '.csv';
            const blob = new Blob([csv_string], { type: 'text/csv;charset=utf-8;' });

            // Cria um link tempor√°rio para download
            const link = document.createElement("a");
            if (link.download !== undefined) { // Recurso HTML5 para download
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Seu navegador n√£o suporta download autom√°tico de arquivos CSV. Por favor, copie o conte√∫do da tabela.');
            }
        }

        // FUN√á√ÉO MODIFICADA: Agora exibe os dados em um modal
        function exibirDadosAtendimento(button) {
            const motivo = button.dataset.motivo;
            const solucao = button.dataset.solucao;
            const dataHora = button.dataset.datahora;
            const nomeCliente = button.dataset.nomecliente;
            const empresaCliente = button.dataset.empresacliente;
            const canal = button.dataset.canal;
            const telefone = button.dataset.telefone;
            const anydesk = button.dataset.anydesk;
            const tipoOcorrencia = button.dataset.tipoocorrencia;
            const protocolo = button.dataset.protocolo;

            const textoParaExibir = `<strong>Tipo de Ocorr√™ncia:</strong> ${tipoOcorrencia || 'N/A'}<br>` +
                                         `<strong>Assunto:</strong> ${motivo || 'N/A'}<br>` +
                                         `<strong>Observa√ß√µes:</strong> ${solucao || 'N/A'}<br>` +
                                         `<strong>Data/Hora do contato:</strong> ${dataHora || 'N/A'}<br>` +
                                         `<strong>Nome:</strong> ${nomeCliente || 'N/A'}<br>` +
                                         `<strong>Empresa:</strong> ${empresaCliente || 'N/A'}<br>` +
                                         `<strong>Canal do contato:</strong> ${canal || 'N/A'}<br>` +
                                         `<strong>Telefone:</strong> ${telefone || 'N/A'}<br>` +
                                         `<strong>AnyDesk:</strong> ${anydesk || 'N/A'}<br>` +
                                         `<strong>Protocolo de Atendimento:</strong> ${protocolo || 'N/A'}`;
            const atendimentoDetailsDisplay = document.getElementById('atendimentoDetailsDisplay');
            if (atendimentoDetailsDisplay) {
                atendimentoDetailsDisplay.innerHTML = textoParaExibir;
            }
        
            dataDisplayModal.style.display = 'flex';
        }

        
        function copyTextFromDisplay() {
            // Altera a refer√™ncia para a nova DIV
            const atendimentoDetailsDisplay = document.getElementById('atendimentoDetailsDisplay');

            // Pega o conte√∫do HTML da div
            let textToCopy = atendimentoDetailsDisplay.innerHTML || '';

            // Substitui as tags <br> por quebras de linha de texto (\n)
            textToCopy = textToCopy.replace(/<br>/g, '\n');

            // Remove as tags <strong> para deixar o texto limpo
            textToCopy = textToCopy.replace(/<strong>/g, '').replace(/<\/strong>/g, '');

            // Tenta usar a API de Clipboard moderna primeiro
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        alert('Cadastro copiado, meu camarada üëç');
                    })
                    .catch(err => {
                        console.error('Erro ao copiar: ', err);
                        alert('Erro ao copiar o texto. Por favor, selecione e copie manualmente.');
                    });
            } else {
                // Fallback para navegadores mais antigos ou contextos n√£o seguros
                try {
                    // Cria um elemento tempor√°rio para selecionar o texto
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = textToCopy;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    alert('Cadastro copiado, meu camarada üëç (M√©todo alternativo)');
                } catch (err) {
                    console.error('Erro no fallback de c√≥pia: ', err);
                    alert('Erro ao copiar o texto. Por favor, selecione e copie manualmente.');
                }
            }
        }
    </script>
</body>
</html>